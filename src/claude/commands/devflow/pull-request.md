---
allowed-tools: Task, Bash
description: Create pull request with comprehensive analysis and smart description generation
---

## Your task

Create a pull request from the current branch with a comprehensive description generated by analyzing commits and code changes. This command orchestrates PR creation using the `pull-request` sub-agent for deep analysis.

### Step 1: Parse Arguments and Detect Context

Parse the arguments to determine base branch and PR options:

```bash
# Parse arguments
BASE_BRANCH=""
DRAFT_FLAG=""

for arg in $ARGUMENTS; do
  case $arg in
    --draft)
      DRAFT_FLAG="--draft"
      ;;
    *)
      if [ -z "$BASE_BRANCH" ]; then
        BASE_BRANCH="$arg"
      fi
      ;;
  esac
done

# Get current branch
CURRENT_BRANCH=$(git branch --show-current)
if [ -z "$CURRENT_BRANCH" ]; then
    echo "‚ùå Not on a branch (detached HEAD). Checkout a feature branch first."
    exit 1
fi

# Auto-detect base branch if not specified
if [ -z "$BASE_BRANCH" ]; then
  for branch in main master develop; do
    if git show-ref --verify --quiet refs/heads/$branch; then
      BASE_BRANCH=$branch
      break
    fi
  done
fi

if [ -z "$BASE_BRANCH" ]; then
    echo "‚ùå Could not auto-detect base branch. Specify manually: /pull-request <base-branch>"
    exit 1
fi

echo "=== PR CREATION CONTEXT ==="
echo "Current branch: $CURRENT_BRANCH"
echo "Base branch: $BASE_BRANCH"
echo "Draft mode: ${DRAFT_FLAG:-disabled}"
echo ""
```

### Step 2: Pre-Flight Checks

Verify the branch state and catch common issues:

```bash
echo "=== PRE-FLIGHT CHECKS ==="

# Check if branch has commits ahead of base
COMMITS_AHEAD=$(git rev-list --count $BASE_BRANCH..HEAD)
if [ "$COMMITS_AHEAD" -eq 0 ]; then
    echo "‚ùå No commits to create PR. Branch is up to date with $BASE_BRANCH."
    exit 1
fi

# Check if PR already exists for this branch
EXISTING_PR=$(gh pr list --head "$CURRENT_BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")
if [ -n "$EXISTING_PR" ]; then
    echo "‚ö†Ô∏è PR #$EXISTING_PR already exists for branch $CURRENT_BRANCH"
    echo "View: gh pr view $EXISTING_PR"
    echo "Update: git push to update existing PR"
    exit 1
fi

# Check if branch is pushed to remote
if ! git ls-remote --exit-code --heads origin "$CURRENT_BRANCH" >/dev/null 2>&1; then
    echo "‚ö†Ô∏è Branch not pushed to remote. Pushing now..."
    git push -u origin "$CURRENT_BRANCH"
fi

# Show quick summary
echo "‚úÖ Ready to create PR"
echo "   Commits: $COMMITS_AHEAD ahead of $BASE_BRANCH"
git log --oneline $BASE_BRANCH..HEAD | head -5
echo ""
```

### Step 3: Launch Pull Request Sub-Agent

Launch the `pull-request` sub-agent to analyze commits and generate PR content:

**IMPORTANT**: Pass these variables to the sub-agent:
- `CURRENT_BRANCH`: The branch being reviewed
- `BASE_BRANCH`: The base branch for comparison

The sub-agent will:
1. Analyze commit history and messages
2. Analyze code changes and impact
3. Extract issue references
4. Detect breaking changes
5. Generate PR title and comprehensive description
6. Assess PR size and suggest splits if needed

Use the Task tool to launch the sub-agent with subagent_type="pull-request":

```
Launch pull-request sub-agent with:
- Current branch: {CURRENT_BRANCH}
- Base branch: {BASE_BRANCH}

The sub-agent will analyze all commits and changes between {BASE_BRANCH} and {CURRENT_BRANCH}, then generate:
- PR title following conventional commit format
- Comprehensive PR description with:
  - Summary of changes
  - Breaking changes (if any)
  - Testing recommendations
  - Related issues
- Size assessment and recommendations

Return the complete PR title and description ready for `gh pr create`.
```

### Step 4: Review Sub-Agent Output

After the sub-agent completes, extract the generated PR content and present it to the user for review:

```markdown
üìù GENERATED PR CONTENT

**Title:**
{generated PR title}

**Description:**
{generated PR description}

---

**Size Assessment:**
- Files changed: {X}
- Lines changed: {Y}
- Complexity: {Simple/Medium/Complex/Too Large}

{If too large, show recommendations for splitting}

**Recommendations from analysis:**
{Any warnings or suggestions from sub-agent}
```

### Step 5: Create Pull Request

Create the PR using `gh pr create` with the generated content:

```bash
# Save PR body to temp file to preserve formatting
PR_BODY=$(cat <<'EOF'
{generated PR description from sub-agent}
EOF
)

# Create the PR
gh pr create \
  --base "$BASE_BRANCH" \
  --head "$CURRENT_BRANCH" \
  --title "{generated PR title}" \
  --body "$PR_BODY" \
  $DRAFT_FLAG

# Capture the PR URL
PR_URL=$(gh pr view --json url --jq '.url' 2>/dev/null || echo "")
```

### Step 6: Provide Success Summary

Present the final summary to the user:

```markdown
‚úÖ PULL REQUEST CREATED

üîó **PR URL:** {PR_URL}

üìä **Summary:**
- Branch: {CURRENT_BRANCH} ‚Üí {BASE_BRANCH}
- Commits: {X} commits
- Files: {Y} files changed
- Status: {Draft/Ready for review}

üí° **Next Steps:**
- View PR: gh pr view {PR_NUMBER}
- Request reviews: gh pr edit {PR_NUMBER} --add-reviewer @username
- Monitor CI checks: gh pr checks {PR_NUMBER}
- If changes needed, push commits or use /resolve-comments after review

üìù **Full PR details:** {PR_URL}
```

---

## Usage Examples

### Basic Usage
```bash
# Create PR to main branch (auto-detected)
/pull-request

# Create PR to develop branch
/pull-request develop

# Create draft PR
/pull-request --draft

# Create draft PR to specific base
/pull-request develop --draft
```

### When to Use

**‚úÖ Use /pull-request when:**
- You have commits ready for review
- Branch is ready for team review
- You want comprehensive PR description
- You want to detect breaking changes automatically

**‚ö†Ô∏è Before using:**
- Run `/code-review` to validate quality
- Ensure all commits are meaningful (not WIP)
- Consider if PR is too large (should it be split?)

**üí° Pro Tips:**
- For small PRs (<10 files), this generates great descriptions automatically
- For large PRs (>20 files), consider the split recommendations
- Draft PRs are great for early feedback without formal review requests
- PR description can be edited after creation with `gh pr edit`

---

## Command Behavior

### Pre-Flight Validation:
- ‚úÖ Verifies branch has commits ahead of base
- ‚úÖ Checks for existing PRs on this branch
- ‚úÖ Ensures branch is pushed to remote
- ‚úÖ Validates base branch exists

### PR Content Generation:
- ‚úÖ Analyzes all commits since branching from base
- ‚úÖ Groups changes by feature/fix/refactor
- ‚úÖ Extracts issue references automatically
- ‚úÖ Detects breaking changes from commit messages
- ‚úÖ Generates testing recommendations

### Safety Features:
- ‚ö†Ô∏è Warns if PR is too large (>500 lines changed)
- ‚ö†Ô∏è Suggests splitting strategy for large PRs
- ‚ö†Ô∏è Detects missing tests or documentation
- ‚ö†Ô∏è Highlights security-sensitive changes

### Integration:
- Works seamlessly with `/code-review` (run before PR creation)
- Complements `/resolve-comments` (for handling feedback after PR)
- Follows conventional commit format for consistency
